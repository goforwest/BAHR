# ๐ API Conventions & Response Envelope
ุขุฎุฑ ุชุญุฏูุซ: 2025-11-09 (ููุญุฏููุซ: ุชุซุจูุช ุดูู ุฑุณุงูุฉ ุงูุฎุทุฃ ูุณูุณูุฉ ูู localizedุ ุฅุถุงูุฉ ุชูุซูู Content-Language ุงููุนููุ ุชูุถูุญ ูุนุงูุฌุฉ RequestValidationErrorุ ูุฅุฒุงูุฉ ุงููุจุณ ุญูู ุงูุฑุณุงุฆู ุซูุงุฆูุฉ ุงูุญููู)

## 1. ุงููุฏู
ุชูุญูุฏ ุดูู ูู ุงูุงุณุชุฌุงุจุงุช ู ุงููุนุงููุฑ (ุงูุชุณููุงุชุ ุงูุฃุฎุทุงุกุ ุงูุฑุคูุณ) ูุถูุงู ุชุฌุฑุจุฉ ูุชุณูุฉ ูุณูููุฉ ุงุณุชููุงู ูุงุฌูุงุช ุจูุญูุฑ.

---
## 2. ุงููุณุงุฑุงุช (Routing)
- ุงูุฅุตุฏุงุฑ: ุฌููุน ูุณุงุฑุงุช ุงูู MVP ุชุญุช `/api/v1/`.
- ุงูุตุญุฉ: `/health` (ุจุณูุท)ุ `/health/detailed` (ุชุดุฎูุตู) ุจุฏูู ุจุงุฏุฆุฉ.
- ุงูุชุญููู: `/api/v1/analyze`, `/api/v1/analyze/batch`, `/api/v1/analyze/history`.
 - ุงูููุงุณ (Prometheus): `/metrics` ูุตู (ููุณุชููู ูู ูุฑุงูุจุฉ ุฎุงุฑุฌูุฉ).

---
## 3. ุงูุฑุคูุณ (Headers)
| Header | ุงุชุฌุงู | ูุตู |
|--------|-------|------|
| X-Request-ID | ุทูุจ ู ุฑุฏ | ููุนุฑูู ุชุชุจุน ูุฑูุฏ (ููููุฏ ุฅุฐุง ุบุงุจ) |
| Authorization | ุทูุจ | `Bearer <access_token>` ูููุณุงุฑุงุช ุงููุญููุฉ |
| Content-Language | ุฑุฏ | ุงููุบุฉ ุงููุนููุฉ ููุฑุณุงูุฉ (ar / en) ุชุถูููุง ุงูููุตุฉ ุชููุงุฆูุงู ุงุณุชูุงุฏุงู ุฅูู ุชูุถูู ุงูุนููู ุฃู ุงูุงูุชุฑุงุถู |
| Accept-Language | ุทูุจ | ุชูุถูู ูุบุฉ ุฑุณุงุฆู ุงูุฎุทุฃ (ุญุงูููุง ar ุฃู en) |
| Deprecation (ูุณุชูุจูู) | ุฑุฏ | ุชุงุฑูุฎ/ุฑุงุจุท ุฅููุงู ุงููุณุงุฑ |
| Sunset (ูุณุชูุจูู) | ุฑุฏ | ุชุงุฑูุฎ ููุงูุฉ ุฏุนู ุงููุณุงุฑ |

---
## 4. ุฌุณู ุงูุงุณุชุฌุงุจุฉ ุงูููุญุฏ (Unified Envelope)
```jsonc
// ูุฌุงุญ
{
  "success": true,
  "data": { "analysis_id": "...", "meter": {"name": "ุงูุทููู"} },
  "error": null,
  "meta": {
    "request_id": "c5f1-...",
    "timestamp": 1731043200,
    "processing_time_ms": 132,
    "cached": false,
    "version": "1.0.0",
    "analysis_engine_version": "1.0.0"
  }
}

// ูุดู (ูุซุงู ุชุญูู ุฃู ููุทู)
{
  "success": false,
  "data": null,
  "error": {
    "code": "ERR_INPUT_002",
    "message": "ุงููุต ูุตูุฑ ุฌุฏุงู. ูููุถู ุฅุฏุฎุงู ุจูุช ูุงูู ุนูู ุงูุฃูู", // ุณูุณูุฉ ูุงุญุฏุฉ ู localized ุญุณุจ Accept-Language
    "severity": "warning",
    "can_retry": false,
    "details": [
      {"field": ["body","text"], "issue": "value_error.any_str.min_length"}
    ]
  },
  "meta": {
    "request_id": "c5f1-...",
    "timestamp": 1731043233,
    "version": "1.0.0",
    "analysis_engine_version": "1.0.0"
  }
}
```

ุฎุตุงุฆุต ุญูู `error` (ููุญุฏููุซ):
| ุญูู | ูุตู | ููุฒู | ููุงุญุธุงุช |
|------|------|-------|-----------|
| code | ุฑูุฒ ุถูู ูุทุงู ุงูุชุตููู | ูุนู | ุงูุธุฑ ุฌุฏูู ุงูุฎุฑุงุฆุท |
| message | ูุต ุจุดุฑู ุจุญุณุจ ุงููุบุฉ ุงููุฎุชุงุฑุฉ (ุณูุณูุฉ ูุงุญุฏุฉ) | ูุนู | ููุญุฏุฏ ุนุจุฑ `Accept-Language`ุ ุชูุฑุณู ุงูููุตุฉ `Content-Language` ูู ุงูุฑุฏ |
| severity | info / warning / error / critical | ูุนู | ุงูุงูุชุฑุงุถู `error` |
| can_retry | ูู ูู ุงูููุทูู ุฅุนุงุฏุฉ ุงููุญุงููุฉุ | ูุนู | ูุญุฏุฏ ููุทู ุงูุนููู |
| details | ูุงุฆูุฉ ุฃุฎุทุงุก ุญููู (Validation) | ูุง | ุชุธูุฑ ูุน ุชุญูู ุงูุญููู |
| retry_after | ุซูุงูู ุงูุชุธุงุฑ | ูุง | ุฃุณุงุณุงู ูู 429/Timeout |

---
## 5. ุฃุฎุทุงุก ุดุงุฆุนุฉ ู ุฎุฑุงุฆุท HTTP
| Code | HTTP | ุณุจุจ |
|------|------|------|
| ERR_INPUT_001 | 422 | ูุญุชูู ุบูุฑ ุนุฑุจู ููุงูุฉ |
| ERR_INPUT_002 | 422 | ูุต ุฃูุตุฑ ูู ุงูุญุฏ ุงูุฃุฏูู |
| ERR_INPUT_003 | 413 | ูุต ุฃุทูู ูู ุงููุณููุญ |
| ERR_RATE_001  | 429 | ุชุฌุงูุฒ ุงูุญุฏ ุงููุนุฏู |
| ERR_AUTH_001  | 401 | ุบูุฑ ูุณุฌู ุฏุฎูู |
| ERR_AUTH_002  | 401 | ุชููู ููุชูู |
| ERR_ANALYSIS_001 | 422 | ูุดู ุงูุชุญููู ุงูููุทูู |
| ERR_DB_001 | 500 | ุฎุทุฃ ูุงุนุฏุฉ ุจูุงูุงุช |
| ERR_TIMEOUT_001 | 408 | ูููุฉ ุงูุชูุช (ูุฏ ูุนุงุฏ 500 ุฅู ุฏุงุฎูู) |
| ERR_UNKNOWN_001 | 500 | ุฎุทุฃ ุบูุฑ ูุชููุน |

---
## 6. ุงูุชูุฑูุฉ ุจูู 400 / 422
- 400: ุฎุทุฃ ุจูุงุก JSON ุฃู ุญูู ููููุฏ ุฃุณุงุณู.
- 422: ุจูุงูุงุช ุดูููุง ุตุญูุญ ููู ุบูุฑ ุตุงูุญุฉ ุณูุงูููุง (ูุซุงู: ูุต ุบูุฑ ุนุฑุจู ููุงูุฉุ ุทูู ุงูุจูุช ุฎุงุฑุฌ ุงููุณููุญ).

---
## 7. ุงูุชุนุฑูุจ (Localization)
- ุงููุบุฉ ุงูุงูุชุฑุงุถูุฉ: ุงูุนุฑุจูุฉ.
- ุนูุฏ ูุฌูุฏ `Accept-Language: en` ุฃู `?lang=en` ููุนุงุฏ `error.message` ุจุงูุฅูุฌููุฒูุฉ.
- ูุง ุชูุชุฑุฌู ุงูุญููู ุงูุชูููุฉ (ูุซู ุฃุณูุงุก ุงูุจุญูุฑ) ูุง ูู ูุชููุฑ ุญูู ุฅูุฌููุฒู ููุงุจู ูู ูููุฐุฌ ุงูุจูุงูุงุช.
- ุฅู ูู ููุนุฑูู `code` ูู ุงููุชุงููุฌุ ุชูุนุงุฏ ุฑุณุงูุฉ ุนุงูุฉ: "ุญุฏุซ ุฎุทุฃ" / "An error occurred".

---
## 8. ุงูุชุฑููู ู ุงูุชูุงูู (Versioning & Compatibility)
- ุญูู `version` ูู meta ููุซู ุฅุตุฏุงุฑ API ุงูุญุงูู.
- ุญูู `analysis_engine_version` ูุดูุฑ ุฅูู ูุณุฎุฉ ุงููุญุฑู (ููุชุตุญูุญ ูููุงุฑูุฉ ุงูุฌูุฏุฉ).
- ุนูุฏ ูุฑุจ ุฅููุงู ูุณุงุฑ: ุฅุถุงูุฉ `Deprecation` header ูุน ุฑุงุจุท ูุซููุฉ ุงูุฅููุงู.

---
## 9. ุชุฌุงูุณ ุงูุญููู (Field Normalization)
- ุฌููุน ุงููุนุฑูุงุช: `snake_case` ูู JSON (ุซุงุจุช).
- ุชูุงุฑูุฎ: ISO8601 (UTC) ูุณูุณูุฉ.
- ุงูุฃุฑูุงู ุงูุนุดุฑูุฉ: JSON ุนุฏุฏูุฉ (ูุง ูุต). ุฏูุฉ ูุตูู: 4 ููุงุฒู.

ุญููู `meta` ุงูููุฒููุฉ:
| ุงูุญูู | ููุฒู | ูุตู |
|-------|------|------|
| request_id | ูุนู | ูููููุฏ ุฅู ุบุงุจ |
| timestamp | ูุนู | Epoch seconds |
| version | ูุนู | ุฅุตุฏุงุฑ ุงูู API |
| analysis_engine_version | ูุนู | ูุณุฎุฉ ูุญุฑู ุงูุชุญููู |
| processing_time_ms | ูุนู (ููุณุงุฑุงุช ุงูุชุญููู) | ุฒูู ูุนุงูุฌุฉ ุงูุทูุจ |
| cached | ูุนู (ุฅุฐุง ููุฌุฏ ูุงุด) | ุงูุชุฑุงุถู false ุญุชู ุชูุนูู ุงููุงุด |

---
## 10. ุงูุชุญูู ูู ุงูุณูุงูุฉ (Validation Contract)
ุฅุฐุง ูุดู Pydantic (RequestValidationError) ุชูุนุงุฏ ุตูุบูุฉ ูููุงุณูุฉ:
```jsonc
{
  "success": false,
  "data": null,
  "error": {
    "code": "ERR_INPUT_003", // ุชู ุงูุชูุญูุฏ: ุชูุณูู/ูููุฉ ุบูุฑ ุตุงูุญุฉ
    "message": "ุจูุงูุงุช ุงูุฅุฏุฎุงู ุบูุฑ ุตุงูุญุฉ",
    "severity": "warning",
    "can_retry": false,
    "details": [
      {"field": ["body","text"], "issue": "value_error.any_str.min_length"}
    ]
  },
  "meta": {"request_id": "...", "timestamp": 1731043200, "version": "1.0.0", "analysis_engine_version": "1.0.0"}
}
```

ููุงุญุธุฉ: ุชู ุฅูุบุงุก ุงููููุฐุฌ ุงูุซูุงุฆู (ุจุงูุนุฑุจูุฉ + ุงูุฅูุฌููุฒูุฉ ุฏุงุฎู ูุงุฆู ูุงุญุฏ) ูุงุนุชูุงุฏ ุฑุณุงูุฉ ูุงุญุฏุฉ ูุฎุตุตุฉ ุญุณุจ ุงููุบุฉุ ููุง ูููู ุงูุญูู ุนูู ุงูุนููุงุก ููุจุณูุท ุงูุชุฎุฒูู ุงููุคูุช.

---
## 11. ุฃูุซูุฉ Curl
```bash
# ุชุญููู ุจูุช
curl -X POST http://localhost:8000/api/v1/analyze \
  -H 'Content-Type: application/json' \
  -d '{"text": "ููุง ูุจู ูู ุฐูุฑู ุญุจูุจ ูููุฒู"}'

# ูุน ุทูุจ ุงูุฅูุฌููุฒูุฉ
curl -X POST 'http://localhost:8000/api/v1/analyze?lang=en' \
  -H 'Content-Type: application/json' \
  -H 'Accept-Language: en' \
  -d '{"text": "ููุง ูุจู ูู ุฐูุฑู ุญุจูุจ ูููุฒู"}'
```

---
## 12. ุญุงูุงุช ุงูุญุงูุฉ (Edge Cases)
| ุญุงูุฉ | ุชุตุฑู ูุชููุน |
|-------|-------------|
| ูุต ูุงุฑุบ | 422 ูุน ERR_INPUT_002 |
| ูุต ุญุฑูู ูุงุชูููุฉ ููุท | 422 ูุน ERR_INPUT_001 |
| ุทูุจ ุชุญููู ููุฑุฑ ุฎูุงู TTL | ููุณ ุงููุชูุฌุฉ ูุน meta.cached=true |
| ุงูุฎูุถุช ุงูุซูุฉ <0.65 | ุนุฑุถ ุจุฏุงุฆู (ุญุชู 3) |
| ุชุฌุงูุฒ ูุนุฏู | 429 ูุน retry_after ู can_retry=true |

---
## 13. ุงุฎุชุจุงุฑ ุงูุชูุงูู (Contract Testing)
- ุงุณุชุฎุฏู Postman ุฃู pytest schema validation ูููุงุฑูุฉ ุงูุงุณุชุฌุงุจุฉ ูุน ุดูู envelope.
- ุฃู ุชุบููุฑ ูู ุงูุญููู ุงูุฃุณุงุณูุฉ ูุชุทูุจ ุชุญุฏูุซ `ARCHITECTURE_OVERVIEW.md` + ูุดุฑ ููุงุญุธุฉ ูู `CRITICAL_CHANGES.md`.

---
## 14. ุงูุชูุซูู ุงููุณุชูุจูู
- ุฅุถุงูุฉ `OpenAPI extension` ูุญูู ุงูุซูุฉ ุงููุนุงูุฑุฉ.
- ุชูุซูู pagination ุงูููุงุณู `page, per_page, total, total_pages`.

---
## 15. ููุฎุต ุงูุชุบููุฑุงุช (Recent Changes Summary)
| ุฑูู | ุงูุชุบููุฑ | ุงูุณุจุจ |
|-----|---------|-------|
| 1 | ุชุซุจูุช ุดูู ุงูุฑุณุงูุฉ ูุณูุณูุฉ ูุงุญุฏุฉ ู localized | ุชุจุณูุท ุงูุงุณุชููุงู ูุชูููู ุงูุญุฌู |
| 2 | ุชูุณูุน `error` ููุดูู `details` ู `retry_after` | ุฏุนู ุชุญูู ุงูุญููู ูุงูุชูุฏุฆุฉ |
| 3 | ุชูุญูุฏ ุชุถููู `processing_time_ms` ู`cached` ูู `meta` | ุงุชุณุงู ุงูููุงุณ ูุงููุชุงุจุนุฉ |
| 4 | ุชุนุฑูู ุตุฑูุญ ููุญููู ุงูููุฒููุฉ ูู `meta` | ููุน ุงูุบููุถ ุฃุซูุงุก ุงูุชูููุฐ |
| 5 | ุชุญุณูู ุตูุงุบุงุช ุญุงูุงุช ุงูุญุงูุฉ | ุฏูุฉ ุงููุตุทูุญุงุช |
| 6 | ุฅุถุงูุฉ ุชูุซูู Content-Language ูุฑุฃุณ ููุถุงู ุขููุงู | ูุถูุญ ุงูุณููู ุงููุนูู |

## 16. ุฎุงุชูุฉ
ูุฐู ุงูุงุชูุงููุงุช ูุนูุงุฑ ุฅูุฒุงูู ููู MVPุ ุฃู ุงูุญุฑุงู ูุฌุจ ุชูุซููู ูู `CRITICAL_CHANGES.md` ูุจู ุงูุฏูุฌ.

### ููุญู: ุชูุงูู OpenAPI
ูุฌุจ ุฃู ูุนูุณ `API_SPECIFICATION.yaml` ูุฎุทุทุงุช `Envelope`, `Meta`, `ErrorObject` ุจูุง ูู ุฐูู ุงูุญููู ุงููุถุงูุฉ (details, retry_after, processing_time_ms, cached)ุ ููุง ูุฌุจ ุงูุชุญูู ูู ุฃูุณุงู `/health` ู`/health/detailed` ูุนุฏู ูุฌูุฏ ุชุถุงุฑุจ ุฃู ุชูุฑุงุฑ ูุจู ุชูููุฏ ุงูุนููุงุก.
